<div class="lega-dettaglio-container">
  <mat-toolbar color="primary" class="header">
    <div class="header-content">
      <h1>Dettaglio lega</h1>
      <div class="user-info">
        <button mat-button (click)="goBack()" class="btn-back">
          ‚Üê Torna alla Home
        </button>
        <button
          mat-raised-button
          color="warn"
          (click)="logout()"
          class="btn-logout"
        >
          Logout
        </button>
      </div>
    </div>
  </mat-toolbar>

  <main class="main-content">
    <div class="lega-dettaglio-container">
      @if (isLoading) {
      <div class="loading">
        <mat-spinner></mat-spinner>
        <p>Caricamento in corso...</p>
      </div>
      } @if (error) {
      <mat-card class="error-card">
        <mat-card-content>{{ error }}</mat-card-content>
      </mat-card>
      } @if (lega) {
      <mat-card class="lega-card">
        <mat-card-header>
          <mat-card-title>{{ lega.nome }}</mat-card-title>
          @if (lega.campionato?.id) {
          <mat-card-subtitle
            >{{ lega.campionato?.sport?.id }} -
            {{ lega.campionato?.nome }}</mat-card-subtitle
          >
          }
          <mat-card-subtitle>
            <div>Giornata calcolata:{{ lega.giornataCalcolata }}</div>
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          @if (isAdmin() ) {
          <mat-icon
            class="calcola-icon"
            (click)="calcolaGiornata()"
            matTooltip="Calcola giornata"
            >sports_esports</mat-icon
          >
          @if (lega.giornataCalcolata ) {
          <mat-icon
            class="calcola-icon"
            (click)="undoCalcolaGiornata()"
            matTooltip="Annulla calcola giornata"
            >restart_alt</mat-icon
          >
          }
          } @if (lega.giocatori?.length) {
          <table
            mat-table
            [dataSource]="lega.giocatori || []"
            class="giocatori-table"
          >
            <ng-container matColumnDef="nome">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let giocatore">
                <span class="nome-giocatore">
                  {{ giocatore.nome }}
                </span>
              </td>
            </ng-container>
            @for (giornata of giornataIndices; track giornata) {
            <ng-container [matColumnDef]="'giocata' + (giornata - 1)">
              <th
                mat-header-cell
                *matHeaderCellDef
                [class.corrente-col]="
                  giornata + lega.giornataIniziale - 1 === lega.giornataCorrente
                "
              >
                <div>Giornata</div>
                <div>{{ giornata + lega.giornataIniziale - 1 }}</div>
                @if (lega.statiGiornate?.[giornata + lega.giornataIniziale - 1])
                {
                <div class="stato-giornata">
                  {{ lega.statiGiornate?.[giornata + lega.giornataIniziale - 1]?.descrizione }}
                </div>
                }
              </th>
              <td
                mat-cell
                *matCellDef="let giocatore"
                [class.corrente-col]="
                  giornata + lega.giornataIniziale - 1 ===
                    lega.giornataCorrente && giocatore.statiPerLega?.[lega.id]?.value !== StatoGiocatore.ELIMINATO.value
                "
                [class.ko-font]="
                  getGiocataByGiornata(giocatore, giornata)?.esito === 'KO'
                "
              >
                <span class="status-pill">
                  <ng-container *ngIf="getGiocataByGiornata(giocatore, giornata) as giocata">
                    <span
                      class="team-name"
                      [ngClass]="{
                        ok: giocata.esito === 'OK',
                        ko: giocata.esito === 'KO',
                        empty: !giocata.esito
                      }"
                      [title]="getSquadraNome(giocata.squadraSigla)"
                    >{{ getSquadraNome(giocata.squadraSigla) | slice : 0 : 14 }}</span>
                  </ng-container>
                  @if (visualizzaGiocata(giornata, giocatore)) {
                    <mat-icon
                      class="gioca-icon"
                      matTooltip="Gioca ora"
                      (click)="giocaGiornata(giocatore, giornata)"
                    >{{ getGiocaIcon() }}</mat-icon>
                  }
                </span>
              </td>
            </ng-container>
            }
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: displayedColumns"
              [class.eliminato-row]="row.statiPerLega?.[lega.id]?.value === StatoGiocatore.ELIMINATO.value"
            ></tr>
          </table>
          }
        </mat-card-content>
      </mat-card>
      }
    </div>
  </main>
</div>
