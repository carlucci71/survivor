<div class="lega-dettaglio-container">
  <app-header [title]="'LEAGUE.LEAGUE_DETAILS' | translate" (back)="goBack()" (logout)="logout()"></app-header>

  <main class="main-content">
    <div class="lega-dettaglio-container">
      @if (isMock) {
          {{beDataRiferimento}}
      }
      @if (error) {
      <mat-card class="error-card">
        <mat-card-content>{{ error }}</mat-card-content>
      </mat-card>
      } @if (lega) {
      <mat-card class="lega-card">
        <mat-card-header>
          <mat-card-title>{{ lega.name }} - {{ 'LEAGUE.EDITION' | translate }} {{ lega.edizione }}</mat-card-title>
          <mat-card-subtitle>
            <mat-card-subtitle>{{ (lega.campionato?.sport?.id ?? '') | translateLeagueData: 'sport' }} -
              {{ (lega.campionato?.id ?? '') | translateLeagueData: 'championship' }} - {{lega.anno}}</mat-card-subtitle>
            @if (lega.giornataCalcolata){
            <div>{{ 'LEAGUE.CALCULATED_ROUND' | translate }}: {{ getDesGiornataTitle(lega.giornataCalcolata) }}</div>
            }
            @if (lega.giornataDaGiocare <= lega.campionato?.numGiornate!!){ <div>{{ 'LEAGUE.NEXT_CHAMPIONSHIP_ROUND' | translate }}: {{
              getDesGiornataTitle(lega.giornataDaGiocare) }}
            </div>
          }
    <div>{{ 'LEAGUE.YOUR_ROLE' | translate }}: {{ lega.ruoloGiocatoreLega ? lega.ruoloGiocatoreLega.descrizione : ''}}</div>
    <div>{{ 'LEAGUE.LEAGUE_STATE' | translate }}: {{ lega.stato.descrizione }}</div>
    @if (lega.giornataFinale) {
      <div>{{ 'LEAGUE.FINAL_ROUND' | translate }}: {{lega.giornataFinale}}</div>
    }
          </mat-card-subtitle>
        </mat-card-header>

        @if (!this.isTerminata()){
        <!-- COUNTDOWN TIMER - Centrato con spazio sopra -->
        <div class="countdown-timer-section">
          @if(countdownActive && shouldShowExpiredCountdown()) {
          <div class="countdown-wrapper" [class.expired]="countdownExpired">
            <mat-icon class="countdown-icon">schedule</mat-icon>
            <div class="countdown-content">
              <span class="countdown-time">{{ countdown }}</span>
            </div>
          </div>
          } @else if(countdownActive && !countdownExpired) {
          <div class="countdown-wrapper">
            <mat-icon class="countdown-icon">schedule</mat-icon>
            <div class="countdown-content">
              <span class="countdown-label">{{ 'LEAGUE.CLOSING_IN' | translate }}</span>
              <span class="countdown-time">{{ countdown }}</span>
            </div>
          </div>
          } @else if(lega.inizioProssimaGiornata) {
          <div class="prossimo-inizio">{{ 'LEAGUE.NEXT_START' | translate }}: {{ lega.inizioProssimaGiornata }}</div>
          }
        </div>
      }
    <mat-card-content>

      @if (isAdmin() || this.isLeaderLega()) { @if (isAvviata()){
      <div class="admin-actions">
        <div class="admin-action-item" (click)="calcolaGiornata()">
          <mat-icon class="calcola-icon">calculate</mat-icon>
          <span class="action-label">{{ 'LEAGUE.CALCULATE' | translate }}</span>
        </div>
        <div class="admin-action-item" (click)="undoCalcolaGiornata()">
          <mat-icon class="calcola-icon">undo</mat-icon>
          <span class="action-label">{{ 'COMMON.CANCEL' | translate }}</span>
        </div>
        <div class="admin-action-item" (click)="sospensioni()">
          <mat-icon class="calcola-icon">pause_circle</mat-icon>
          <span class="action-label">{{ 'LEAGUE.SUSPENSIONS' | translate }}</span>
        </div>
        @if (isChiudibile()){
        <div class="admin-action-item" (click)="termina()">
          <mat-icon class="calcola-icon">lock</mat-icon>
          <span class="action-label">{{ 'COMMON.CLOSE' | translate }}</span>
        </div>
        }
      </div>
      } @if (isTerminata() && notExistsNuovaEdizione() ){
      <div class="admin-actions admin-actions-small">
        <div class="admin-action-item small" (click)="riapri()">
          <mat-icon class="calcola-icon">lock_open</mat-icon>
          <span class="action-label">{{ 'LEAGUE.REOPEN' | translate }}</span>
        </div>
        @if (contaAttivi()==0) {
        <div class="admin-action-item small" (click)="secondaOccasione()">
          <mat-icon class="calcola-icon">replay</mat-icon>
          <span class="action-label">{{ 'LEAGUE.SECOND_CHANCE' | translate }}</span>
        </div>
        }
      </div>
      }


      } @if (lega.giocatori?.length) {

      <!-- BOTTONE GIOCA PRINCIPALE - IN PRIMO PIANO -->
      @if (getCurrentGiocatore() && hasGiocataDisponibile(getCurrentGiocatore())) {
        <div class="play-action-primary">
          <button class="btn-play-primary" (click)="giocaGiornataDisponibile(getCurrentGiocatore())">
            <mat-icon class="play-icon-primary">{{ getGiocaIcon() }}</mat-icon>
            <span class="play-label-primary">{{ 'LEAGUE.PLAY_NOW' | translate }}</span>
          </button>
        </div>
      }

      <!-- RICERCA E FILTRI PER DESKTOP/TABLET -->
      <div class="desktop-filters-section desktop-tablet-only">
        <!-- Ricerca utente -->
        <div class="search-bar-desktop">
          <mat-icon class="search-icon-desktop">search</mat-icon>
          <input
            type="text"
            class="search-input-desktop"
            [(ngModel)]="searchText"
            (ngModelChange)="onSearchChange()"
            placeholder="Cerca giocatore..."
          />
          <button *ngIf="searchText" class="clear-search-btn-desktop" (click)="clearSearch()">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <!-- Filtri chips -->
        <div class="filter-chips-desktop">
          <button
            class="filter-chip-desktop"
            [class.active]="playerFilter === 'all'"
            (click)="setPlayerFilter('all')"
          >
            <span class="chip-label-desktop">Tutti</span>
            <span class="chip-count-desktop">{{ getTotalPlayersCount() }}</span>
          </button>
          <button
            class="filter-chip-desktop active-chip"
            [class.active]="playerFilter === 'active'"
            (click)="setPlayerFilter('active')"
          >
            <span class="chip-label-desktop">Attivi</span>
            <span class="chip-count-desktop">{{ getActivePlayersCount() }}</span>
          </button>
          <button
            class="filter-chip-desktop eliminated-chip"
            [class.active]="playerFilter === 'eliminated'"
            (click)="setPlayerFilter('eliminated')"
          >
            <span class="chip-label-desktop">Eliminati</span>
            <span class="chip-count-desktop">{{ getEliminatedPlayersCount() }}</span>
          </button>
        </div>
      </div>

      <!-- VISTA DESKTOP/TABLET - Tabella Compatta Tipo Excel -->
      <div class="excel-table-wrapper desktop-tablet-only">
        <div class="excel-table-scroll">
          <table class="excel-table">
            <!-- HEADER FISSO -->
            <thead>
              <tr class="excel-header-row">
                <th class="excel-header-cell user-col">Utente</th>
                <th class="excel-header-cell status-col">Stato</th>
                @for (giornata of giornataIndices; track giornata) {
                  <th class="excel-header-cell round-col"
                      [class.current-round]="giornata === lega.giornataCorrente">
                      <div>{{ getDesGiornataTitle(giornata) }}</div>
                      @if(getStatoGiornata(giornata)?.value != StatoPartita.TERMINATA.value){
                        <div> {{getStatoGiornata(giornata)?.descrizione}} </div>
                      }
                  </th>
                }
                @if(isAdmin() || isLeaderLega() || isDaAvviare()){
                  <th class="excel-header-cell actions-col">Azioni</th>
                }
              </tr>
            </thead>

            <!-- BODY -->
            <tbody>
              @for (giocatore of getFilteredPlayers(); track giocatore.id) {
                <tr class="excel-data-row"
                    [class.eliminated]="giocatore.statiPerLega?.[lega.id]?.value === StatoGiocatore.ELIMINATO.value">

                  <!-- NOME UTENTE -->
                  <td class="excel-cell user-cell">
                    <div class="user-name-wrapper">
                      <span class="user-name">{{ giocatore.nickname }}</span>
                      <!-- Icona per visualizzare storico completo se ci sono piÃ¹ di 5 giornate -->
                      @if(hasMoreRounds(giocatore)) {
                        <button class="history-toggle-btn"
                                (click)="toggleFullHistory(giocatore, $event)"
                                [matTooltip]="'LEAGUE.SHOW_FULL_HISTORY' | translate">
                          <mat-icon class="history-icon">history</mat-icon>
                          <span class="history-count">{{ getTotalRoundsCount(giocatore) }}</span>
                        </button>
                      }
                    </div>
                  </td>

                  <!-- STATO -->
                  <td class="excel-cell status-cell">
                    <span class="status-indicator"
                          [class.active]="giocatore.statiPerLega?.[lega.id]?.value !== StatoGiocatore.ELIMINATO.value"
                          [class.eliminated]="giocatore.statiPerLega?.[lega.id]?.value === StatoGiocatore.ELIMINATO.value">
                    </span>
                  </td>

                  <!-- GIORNATE (Limitate o Complete) -->
                  @for (giornata of getVisibleGiornateForPlayer(giocatore); track giornata) {
                    <td class="excel-cell round-cell"
                        [class.current-round]="giornata === lega.giornataCorrente"
                        [class.cell-ok]="getGiocataByGiornataAssoluta(giocatore, giornata)?.esito === 'OK'"
                        [class.cell-ko]="getGiocataByGiornataAssoluta(giocatore, giornata)?.esito === 'KO'">

                      @if(getGiocataByGiornataAssoluta(giocatore, giornata)?.squadraSigla) {
                        <div class="giocata-cell-content">
                          <!-- Mostra il nome COMPLETO della squadra o badge "Voto Privato" se nascosta -->
                          <span
                            [class]="shouldHideGiocata(getGiocataByGiornataAssoluta(giocatore, giornata), giornata) ? 'private-vote-badge' : 'team-name-compact'"
                            [title]="shouldHideGiocata(getGiocataByGiornataAssoluta(giocatore, giornata), giornata) ? 'Voto nascosto fino all\'inizio della giornata' : getSquadraNome(getGiocataByGiornataAssoluta(giocatore, giornata)?.squadraSigla)">
                            {{ getDisplaySquadraNome(giocatore, giornata) }}
                          </span>
                          <!-- Indicatore forzatura -->
                          @if(getGiocataByGiornataAssoluta(giocatore, giornata)?.forzatura) {
                            <mat-icon class="forced-icon"
                                      [matTooltip]="'LEAGUE.FORCED_BY_LEADER' | translate">
                              verified_user
                            </mat-icon>
                          }
                        </div>
                      } @else {
                        <!-- Cella vuota -->
                        <span class="empty-cell">-</span>
                      }
                    </td>
                  }

                  <!-- AZIONI (ultima colonna) -->
                  @if(isAdmin() || isLeaderLega() || isDaAvviare()){
                    <td class="excel-cell actions-cell">
                      <div class="actions-wrapper">
                        <!-- Icona modifica per leader/admin (se puÃ² giocare per questo utente) -->
                        @if((isAdmin() || isLeaderLega()) && hasGiocataDisponibile(giocatore)){
                          <mat-icon class="action-icon edit-icon"
                                    (click)="giocaGiornataDisponibile(giocatore)"
                                    [matTooltip]="'LEAGUE.PLAY_FOR_USER' | translate">
                            edit
                          </mat-icon>
                        }
                        @if(isDaAvviare() && (isAdmin() || isLeaderLega())){
                          <mat-icon class="action-icon delete-icon"
                                    (click)="cancellaGiocatore(giocatore)"
                                    matTooltip="Rimuovi giocatore">
                            close
                          </mat-icon>
                        }
                      </div>
                    </td>
                  }
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

      <!-- Vista Cards Moderna - Responsive per tutti i dispositivi -->
      <div class="cards-view-responsive">

        <!-- FILTRI E RICERCA MODERNI -->
        <div class="mobile-filters-section">
          <!-- Ricerca veloce -->
          <div class="search-bar-container">
            <mat-icon class="search-icon">search</mat-icon>
            <input
              type="text"
              class="search-input"
              [(ngModel)]="searchText"
              (ngModelChange)="onSearchChange()"
              placeholder="{{ 'LEAGUE.SEARCH_PLAYER' | translate }}"
            />
            <button *ngIf="searchText" class="clear-search-btn" (click)="clearSearch()">
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <!-- Filtri chips -->
      <div class="filter-chips">
            <button
              class="filter-chip"
              [class.active]="playerFilter === 'all'"
              (click)="setPlayerFilter('all')"
            >
              <span class="chip-label">{{ 'LEAGUE.ALL' | translate }}</span>
              <span class="chip-count">{{ getTotalPlayersCount() }}</span>
            </button>
            <button
              class="filter-chip active-chip"
              [class.active]="playerFilter === 'active'"
              (click)="setPlayerFilter('active')"
            >
              <span class="chip-label">{{ 'LEAGUE.ACTIVE' | translate }}</span>
              <span class="chip-count">{{ getActivePlayersCount() }}</span>
            </button>
            <button
              class="filter-chip eliminated-chip"
              [class.active]="playerFilter === 'eliminated'"
              (click)="setPlayerFilter('eliminated')"
            >
              <span class="chip-label">{{ 'LEAGUE.ELIMINATED' | translate }}</span>
              <span class="chip-count">{{ getEliminatedPlayersCount() }}</span>
            </button>
          </div>
        </div>

        <!-- EMPTY STATE - Nessun risultato -->
        @if (getFilteredPlayers().length === 0) {
          <div class="empty-state">
            <mat-icon class="empty-icon">search_off</mat-icon>
            <div class="empty-title">{{ 'LEAGUE.NO_RESULTS' | translate }}</div>
            <div class="empty-message">
              {{ searchText ? ('LEAGUE.NO_RESULTS_SEARCH' | translate) : ('LEAGUE.NO_RESULTS_FILTER' | translate) }}
            </div>
          </div>
        }

        <!-- LISTA GIOCATORI FILTRATI -->
        <div *ngFor="let giocatore of getFilteredPlayers(); trackBy: trackByGiocatoreId" class="player-card-mobile"
          [class.eliminato-row]="giocatore.statiPerLega?.[lega.id]?.value === StatoGiocatore.ELIMINATO.value"
          [class.expanded]="expandedPlayers[giocatore.id]">

          <!-- Header giocatore compatto - Nome + Freccia sulla stessa riga -->
          <div class="player-header-mobile" (click)="togglePlayerExpansion(giocatore.id)">
            <!-- Sinistra: Cerchietto stato + Nome + Icona storico -->
            <div class="player-info-left">
              <!-- Cerchietto stato PRIMA del nome -->
              <span class="status-indicator-mobile"
                    [class.active]="giocatore.statiPerLega?.[lega.id]?.value !== StatoGiocatore.ELIMINATO.value"
                    [class.eliminated]="giocatore.statiPerLega?.[lega.id]?.value === StatoGiocatore.ELIMINATO.value">
              </span>

              <span class="nome-giocatore-mobile">{{ giocatore.nickname }}</span>

              <!-- Icona storico completo se ci sono piÃ¹ di 5 giocate -->
              @if(hasMoreRounds(giocatore)) {
                <button class="history-toggle-btn-mobile"
                        (click)="$event.stopPropagation(); toggleFullHistory(giocatore, $event)"
                        [matTooltip]="'LEAGUE.SHOW_FULL_HISTORY' | translate">
                  <mat-icon class="history-icon-mobile">history</mat-icon>
                </button>
              }
            </div>

            <!-- Destra: Icona admin + Freccia -->
            <div class="player-actions-right">
              <!-- Icona modifica per leader/admin -->
              @if((isAdmin() || isLeaderLega()) && hasGiocataDisponibile(giocatore)){
                <mat-icon class="edit-user-icon-mobile"
                          (click)="$event.stopPropagation(); giocaGiornataDisponibile(giocatore)"
                          [matTooltip]="'LEAGUE.PLAY_FOR_USER' | translate">
                  edit
                </mat-icon>
              }

              <!-- Freccia espandi/comprimi -->
              <mat-icon class="expand-icon-mobile">
                {{ expandedPlayers[giocatore.id] ? 'keyboard_arrow_up' : 'keyboard_arrow_down' }}
              </mat-icon>
            </div>
          </div>

          <!-- Storia giocate limitata (MAX 5) - ESPANDIBILE -->
          <div class="giornate-list-mobile" *ngIf="expandedPlayers[giocatore.id]" [@expandCollapse]>
            <!-- Header settimane -->
            <div class="settimane-header">
              <div *ngFor="let giornata of getVisibleGiornateForPlayer(giocatore)" class="settimana-col">
                <span class="settimana-label">{{ getDesGiornataTitleMobile(giornata) }}</span>
              </div>
            </div>

            <!-- Giocate -->
            <div class="giocate-row">
              <div *ngFor="let giornata of getVisibleGiornateForPlayer(giocatore)" class="giocata-col">
                <!-- Team scelto -->
                @if(getGiocataByGiornataAssoluta(giocatore, giornata)?.squadraSigla) {
                  <div class="team-cell-mobile"
                       [class.cell-ok]="getGiocataByGiornataAssoluta(giocatore, giornata)?.esito === 'OK'"
                       [class.cell-ko]="getGiocataByGiornataAssoluta(giocatore, giornata)?.esito === 'KO'">
                    @if(getTeamLogo(getGiocataByGiornataAssoluta(giocatore, giornata)?.squadraSigla)) {
                      <img
                        class="team-logo-cell"
                        [src]="getTeamLogo(getGiocataByGiornataAssoluta(giocatore, giornata)?.squadraSigla)"
                        [alt]="getSquadraNome(getGiocataByGiornataAssoluta(giocatore, giornata)?.squadraSigla) || ''"
                        (error)="onLogoError($event)"
                      />
                    }
                    <span class="team-name-cell">{{ getSquadraNome(getGiocataByGiornataAssoluta(giocatore, giornata)?.squadraSigla) }}</span>
                  </div>
                } @else {
                  <!-- Cella vuota -->
                  <div class="empty-cell-mobile">-</div>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
      }


      <!-- SEZIONE ELIMINATO - Mostra quando l'utente corrente Ã¨ stato eliminato -->
      <!-- Posizionato dopo la tabella cosÃ¬ appare sotto alla giocata dell'utente -->
      @if (isCurrentUserEliminato()) {
      <div class="eliminato-banner">
        <div class="eliminato-emoji">ðŸ’€</div>
        <div class="eliminato-content">
          <div class="eliminato-title">{{ 'LEAGUE.YOU_ELIMINATED' | translate }}</div>
          @if (getSquadraEliminazione()) {
          <div class="eliminato-squadra">
            <span class="eliminato-label">{{ 'LEAGUE.YOU_BETRAYED' | translate }}</span>
            <span class="eliminato-team">{{ getSquadraEliminazione()?.nome }}</span>
            <span class="eliminato-giornata">{{ getDesGiornataTitle(getSquadraEliminazione()?.giornata || 0) }}</span>
          </div>
          }
          <div class="eliminato-message">
            {{ getRandomConsolationMessage() }}
          </div>
        </div>
      </div>
      }

      <!-- ELIMINA LEGA - In fondo, discreto -->
      @if (isDaAvviare() && isLeaderLega()) {
      <div class="delete-lega-footer">
        <span class="delete-link" (click)="toggleDeleteConfirm()">
          <mat-icon>delete_outline</mat-icon>
          {{ 'LEAGUE.DELETE_LEAGUE' | translate }}
        </span>
      </div>
      }

      <!-- DIALOG CONFERMA ELIMINAZIONE -->
      @if (showDeleteConfirm) {
      <div class="delete-confirm-overlay" (click)="toggleDeleteConfirm()">
        <div class="delete-confirm-card" (click)="$event.stopPropagation()">
          <div class="delete-confirm-header">
            <mat-icon class="warning-icon">warning</mat-icon>
            <h3>{{ 'LEAGUE.CONFIRM_DELETE_TITLE' | translate }}</h3>
          </div>
          <p class="delete-confirm-message">
            {{ 'LEAGUE.CONFIRM_DELETE_MESSAGE' | translate }}
          </p>
          <div class="delete-confirm-actions">
            <button class="btn-cancel" (click)="toggleDeleteConfirm()">{{ 'LEAGUE.CONFIRM_DELETE_CANCEL' | translate }}</button>
            <button class="btn-delete" (click)="confirmEliminaLega()" [disabled]="isDeleting">
              {{ isDeleting ? ('LEAGUE.CONFIRM_DELETE_DELETING' | translate) : ('LEAGUE.CONFIRM_DELETE_CONFIRM' | translate) }}
            </button>
          </div>
        </div>
      </div>
      }

    </mat-card-content>
    </mat-card>
    }
</div>
</main>
</div>
