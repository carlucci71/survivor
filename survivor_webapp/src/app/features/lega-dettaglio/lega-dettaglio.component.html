<div class="lega-dettaglio-container">
  <app-header
    title="Dettaglio lega"
    (back)="goBack()"
    (logout)="logout()"
  ></app-header>

  <main class="main-content">
    <div class="lega-dettaglio-container">
      @if (error) {
      <mat-card class="error-card">
        <mat-card-content>{{ error }}</mat-card-content>
      </mat-card>
      } @if (lega) {
      <mat-card class="lega-card">
        <mat-card-header>
          <mat-card-title
            >{{ lega.name }} - Edizione {{ lega.edizione }}</mat-card-title
          >
          <mat-card-subtitle>
            <mat-card-subtitle
              >{{ lega.campionato?.sport?.id }} -
              {{ lega.campionato?.nome }}</mat-card-subtitle
            >
            @if (lega.giornataCalcolata){
            <div>Calcolata: {{ getDesGiornataTitle(lega.giornataCalcolata) }}</div>
            }
            @if (lega.giornataDaGiocare <= lega.campionato?.numGiornate!!){
            <div>Prossima di campionato: {{ getDesGiornataTitle(lega.giornataDaGiocare) }}</div>
            }
            <div>Ruolo in Lega: {{ lega.ruoloGiocatoreLega.descrizione }}</div>
            <div>Stato Lega: {{ lega.stato.descrizione }}</div>
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          @if (isAdmin() || this.isLeaderLega()) { @if (isAvviata()){
          <div class="admin-actions">
            <div class="admin-action-item" (click)="calcolaGiornata()">
              <mat-icon class="calcola-icon">calculate</mat-icon>
              <span class="action-label">Calcola</span>
            </div>
            <div class="admin-action-item" (click)="undoCalcolaGiornata()">
              <mat-icon class="calcola-icon">undo</mat-icon>
              <span class="action-label">Annulla</span>
            </div>
            <div class="admin-action-item" (click)="sospensioni()">
              <mat-icon class="calcola-icon">pause_circle</mat-icon>
              <span class="action-label">Sospensioni</span>
            </div>
            @if (isChiudibile()){
            <div class="admin-action-item" (click)="termina()">
              <mat-icon class="calcola-icon">lock</mat-icon>
              <span class="action-label">Chiudi</span>
            </div>
            }
          </div>
          } @if (isTerminata() && notExistsNuovaEdizione() ){
          <div class="admin-actions">
            <div class="admin-action-item" (click)="riapri()">
              <mat-icon class="calcola-icon">lock_open</mat-icon>
              <span class="action-label">Riapri</span>
            </div>
          </div>
          } @if (isTerminata() && notExistsNuovaEdizione() && contaAttivi()==0 ){
          <div class="admin-actions">
            <div class="admin-action-item" (click)="secondaOccasione()">
              <mat-icon class="calcola-icon">replay</mat-icon>
              <span class="action-label">2Â° Occasione</span>
            </div>
          </div>
          } } @if (lega.giocatori?.length) {
          <div class="table-horizontal-wrapper desktop-only">
            <div #tableWrapper class="table-wrapper table-scroll-vertical">
              <table
                  mat-table
                  [dataSource]="lega.giocatori || []"
                  class="giocatori-table"
              >
                <ng-container matColumnDef="nome">
                  <th mat-header-cell *matHeaderCellDef class="headerRow"></th>
                  <!--D Nome del giocatore-->
                  <td mat-cell *matCellDef="let giocatore">
                    @if(isDaAvviare() && (isAdmin() || this.isLeaderLega())){
                    <mat-icon
                      class="calcola-icon"
                      (click)="cancellaGiocatore(giocatore)"
                      matTooltip="Rimuovi il giocatore"
                      >delete</mat-icon
                    >
                    }
                    <span class="nome-giocatore">
                      {{ giocatore.nome }}
                    </span>
                  </td>
                </ng-container>
                @for (giornata of giornataIndices; track giornata) {
                <ng-container [matColumnDef]="'giocata' + (giornata - 1)">
                  <!--D Titolo della giornata-->
                  <th
                    class="headerRow"
                    mat-header-cell
                    *matHeaderCellDef
                    [class.corrente-col]="
                      giornata + lega.giornataIniziale - 1 ===
                      lega.giornataCorrente
                    "
                  >
                    <div>
                      {{
                        getDesGiornataTitle(
                          giornata + lega.giornataIniziale - 1
                        )
                      }}
                    </div>
                    <div class="stato-giornata">
                      {{ lega.statiGiornate?.[giornata + lega.giornataIniziale - 1]?.descrizione }}
                    </div>
                  </th>
                  <!--D Giocata del giocatore/giornata -->
                  <td
                    mat-cell
                    *matCellDef="let giocatore"
                    [class.corrente-col]="
                  giornata + lega.giornataIniziale - 1 ===
                    lega.giornataCorrente && giocatore.statiPerLega?.[lega.id]?.value !== StatoGiocatore.ELIMINATO.value
                "
                    [class.ko-font]="
                      getGiocataByGiornata(giocatore, giornata)?.esito === 'KO'
                    "
                  >
                    <span>
                      <ng-container
                        *ngIf="
                          getGiocataByGiornata(giocatore, giornata) as giocata
                        "
                      >
                        <div
                          *ngIf="giocata.squadraSigla || giocata.esito"
                          class="team-name"
                          [ngClass]="{
                            ok: giocata.esito === 'OK',
                            ko: giocata.esito === 'KO',
                            empty: !giocata.esito
                          }"
                          [title]="getSquadraNome(giocata.squadraSigla)"
                        >
                          {{ getSquadraNome(giocata.squadraSigla) }}
                        </div>
                      </ng-container>
                      @if (visualizzaGiocata(giornata, giocatore)) {
                      <div>
                        <!-- Icona spostata accanto al nome -->
                      </div>
                      }
                    </span>
                  </td>
                </ng-container>
                }
                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr
                  mat-row
                  *matRowDef="let row; columns: displayedColumns"
                  [class.eliminato-row]="row.statiPerLega?.[lega.id]?.value === StatoGiocatore.ELIMINATO.value"
                ></tr>
              </table>
            </div>
          </div>

          <!-- Mobile stacked view: shown only on small screens via CSS -->
          <div class="stacked-view mobile-only">
              <div *ngFor="let giocatore of lega.giocatori" class="player-card"
                [class.eliminato-row]="giocatore.statiPerLega?.[lega.id]?.value === StatoGiocatore.ELIMINATO.value">
              <div class="player-header">
                <span class="nome-giocatore">{{ giocatore.nome }}</span>
                <button
                  *ngIf="lega.giornataCorrente !== undefined && visualizzaGiocata(lega.giornataCorrente - lega.giornataIniziale + 1, giocatore)"
                  mat-raised-button
                  class="gioca-btn-mobile"
                  (click)="giocaGiornata(giocatore, lega.giornataCorrente)"
                >
                  <mat-icon>{{ getGiocaIcon() }}</mat-icon>
                  <span class="btn-text">Gioca</span>
                </button>
              </div>
              <div class="giornate-list">
                <div *ngFor="let giornata of mobileGiornateIndices()" class="giornata-item">
                  <div class="giornata-title">
                    {{ getDesGiornataTitle(giornata + lega.giornataIniziale - 1) }}
                  </div>
                  <div class="stato-giornata-mobile">
                    {{ lega.statiGiornate?.[giornata + lega.giornataIniziale - 1]?.descrizione }}
                  </div>
                  <div class="team-pill"
                    [ngClass]="{
                      ok: getGiocataByGiornata(giocatore, giornata)?.esito === 'OK',
                      ko: getGiocataByGiornata(giocatore, giornata)?.esito === 'KO',
                      empty: !getGiocataByGiornata(giocatore, giornata)?.esito
                    }"
                    [title]="getSquadraNome(getGiocataByGiornata(giocatore, giornata)?.squadraSigla)">
                    {{ getSquadraNome(getGiocataByGiornata(giocatore, giornata)?.squadraSigla) }}
                  </div>
                </div>
              </div>
            </div>
          </div>
          }
        </mat-card-content>
      </mat-card>
      }
    </div>
  </main>
</div>
