<div class="lega-dettaglio-container">
  <mat-toolbar color="primary" class="header">
    <div class="header-content">
      <h1>Dettaglio lega</h1>
      <div class="user-info">
        <button mat-button (click)="goBack()" class="btn-back">
          ‚Üê Torna alla Home
        </button>
        <button
          mat-raised-button
          color="warn"
          (click)="logout()"
          class="btn-logout"
        >
          Logout
        </button>
      </div>
    </div>
  </mat-toolbar>

  <main class="main-content">
    <div class="lega-dettaglio-container">
      @if (isLoading) {
      <div class="loading">
        <mat-spinner></mat-spinner>
        <p>Caricamento in corso...</p>
      </div>
      } @if (error) {
      <mat-card class="error-card">
        <mat-card-content>{{ error }}</mat-card-content>
      </mat-card>
      } @if (lega) {
      <mat-card class="lega-card">
        <mat-card-header>
          <mat-card-title>{{ lega.nome }}</mat-card-title>
          @if (lega.campionato?.id) {
          <mat-card-subtitle
            >{{ lega.campionato?.sport?.id }} -
            {{ lega.campionato?.id }}</mat-card-subtitle
          >
          } 
          <mat-card-subtitle>
            <div>
            Giornata iniziale:{{ lega.giornataIniziale }}
            </div>
            <div>
            Giornata corrente:{{ lega.giornataCorrente }} - {{ lega.statoGiornataCorrente }}
            </div>
            <div>
            Giornata calcolata:{{ lega.giornataCalcolata }}
            </div>
          </mat-card-subtitle>
          
        </mat-card-header>
        <mat-card-content>
          @if (isAdmin() ) {<!--&& giornataTerminata()-->
          <mat-icon
            class="calcola-icon"
            (click)="calcolaGiornata()"
            matTooltip="Calcola giornata"
            >handyman</mat-icon
          >
          } @if (lega.giocatori?.length) {
          <table
            mat-table
            [dataSource]="lega.giocatori || []"
            class="giocatori-table"
          >
            <ng-container matColumnDef="nome">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let giocatore">
                <span class="nome-giocatore">
                  {{ giocatore.nome }}
                </span>
              </td>
            </ng-container>
            @for (giornata of giornataIndices; track giornata) {
            <ng-container [matColumnDef]="'giocata' + (giornata - 1)">
              <th
                mat-header-cell
                *matHeaderCellDef
                  [class.corrente-col]="
                  giornata + lega.giornataIniziale -1 === lega.giornataCorrente
                "
              >
               <div>
                Giornata {{giornata + lega.giornataIniziale -1}}
                </div> 
              </th>
              <td
                mat-cell
                *matCellDef="let giocatore"
                [class.corrente-col]="
                  giornata + lega.giornataIniziale -1 === lega.giornataCorrente &&
                  giocatore.stato !== 'ELIMINATO'
                "
                [class.ko-font]="
                  getGiocataByGiornata(giocatore, giornata)?.esito === 'KO'
                "
              >
                <ng-container
                  *ngIf="getGiocataByGiornata(giocatore, giornata) as giocata"
                >
                  <span class="team-name" [ngClass]="{'ok': giocata.esito === 'OK', 'ko': giocata.esito === 'KO', 'empty': !giocata.esito}" [title]="getSquadraNome(giocata.squadraId)">{{ getSquadraNome(giocata.squadraId) | slice:0:14 }}</span>
                </ng-container>
              </td>
            </ng-container>
            }
            @if (selezionaProssimaGiocata()) {
            <ng-container matColumnDef="prossimaGiocata">
              <th mat-header-cell *matHeaderCellDef>
                Prossima giocata
              </th>
              <td mat-cell *matCellDef="let giocatore; let i = $index">
                @if (selectGiocatoreVisible(giocatore)) {
                <div class="squadra-select-save">
                  <mat-form-field appearance="outline" class="select-squadra">
                    <mat-select
                      placeholder="Seleziona"
                      [(ngModel)]="giocatore.squadraSelezionata"
                      [ngModelOptions]="{ standalone: true }"
                    >
                      @for (squadra of getSquadreDisponibili(giocatore); track
                      squadra.id) {
                      <mat-option [value]="squadra.id">{{
                        squadra.nome
                      }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                  @if (giocatore.squadraSelezionata) {
                  <mat-icon class="save-icon" (click)="salvaSquadra(giocatore)"
                    >save</mat-icon
                  >
                  }
                </div>
                }
              </td>
            </ng-container>
            }
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: displayedColumns"
              [class.eliminato-row]="row.stato === 'ELIMINATO'"
            ></tr>
          </table>
          }
        </mat-card-content>
      </mat-card>
      }
    </div>
  </main>
</div>
