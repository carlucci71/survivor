<div class="lega-dettaglio-container">
  <app-header [title]="'LEAGUE.LEAGUE_DETAILS' | translate" (back)="goBack()" (logout)="logout()"></app-header>

  <main class="main-content">
    <div class="lega-dettaglio-container">
      @if (error) {
      <mat-card class="error-card">
        <mat-card-content>{{ error }}</mat-card-content>
      </mat-card>
      } @if (lega) {
      <mat-card class="lega-card">
        <mat-card-header>
          <mat-card-title>{{ lega.name }} - {{ 'LEAGUE.EDITION' | translate }} {{ lega.edizione }}</mat-card-title>
          <mat-card-subtitle>
            <mat-card-subtitle>{{ lega.campionato?.sport?.id }} -
              {{ lega.campionato?.nome }} - {{lega.anno}}</mat-card-subtitle>
            @if (lega.giornataCalcolata){
            <div>{{ 'LEAGUE.CALCULATED_ROUND' | translate }}: {{ getDesGiornataTitle(lega.giornataCalcolata) }}</div>
            }
            @if (lega.giornataDaGiocare <= lega.campionato?.numGiornate!!){ <div>{{ 'LEAGUE.NEXT_CHAMPIONSHIP_ROUND' | translate }}: {{
              getDesGiornataTitle(lega.giornataDaGiocare) }}
            </div>
          }
    <div>{{ 'LEAGUE.YOUR_ROLE' | translate }}: {{ lega.ruoloGiocatoreLega.descrizione }}</div>
    <div>{{ 'LEAGUE.LEAGUE_STATE' | translate }}: {{ lega.stato.descrizione }}</div>
    @if (lega.giornataFinale) {
      <div>{{ 'LEAGUE.FINAL_ROUND' | translate }}: {{lega.giornataFinale}}</div>
    }
          </mat-card-subtitle>
        </mat-card-header>

        @if (!this.isTerminata()){
        <!-- COUNTDOWN TIMER - Centrato con spazio sopra -->
        <div class="countdown-timer-section">
          @if(countdownActive) {
          <div class="countdown-wrapper" [class.expired]="countdownExpired">
            <mat-icon class="countdown-icon">schedule</mat-icon>
            <div class="countdown-content">
              @if(!countdownExpired) {
                <span class="countdown-label">{{ 'LEAGUE.CLOSING_IN' | translate }}</span>
              }
              <span class="countdown-time">{{ countdown }}</span>
            </div>
          </div>
          } @else if(lega.inizioProssimaGiornata) {
          <div class="prossimo-inizio">{{ 'LEAGUE.NEXT_START' | translate }}: {{ lega.inizioProssimaGiornata }}</div>
          }
        </div>
      }
    <mat-card-content>
      @if (isAdmin() || this.isLeaderLega()) { @if (isAvviata()){
      <div class="admin-actions">
        <div class="admin-action-item" (click)="calcolaGiornata()">
          <mat-icon class="calcola-icon">calculate</mat-icon>
          <span class="action-label">{{ 'LEAGUE.CALCULATE' | translate }}</span>
        </div>
        <div class="admin-action-item" (click)="undoCalcolaGiornata()">
          <mat-icon class="calcola-icon">undo</mat-icon>
          <span class="action-label">{{ 'COMMON.CANCEL' | translate }}</span>
        </div>
        <div class="admin-action-item" (click)="sospensioni()">
          <mat-icon class="calcola-icon">pause_circle</mat-icon>
          <span class="action-label">{{ 'LEAGUE.SUSPENSIONS' | translate }}</span>
        </div>
        @if (isChiudibile()){
        <div class="admin-action-item" (click)="termina()">
          <mat-icon class="calcola-icon">lock</mat-icon>
          <span class="action-label">{{ 'COMMON.CLOSE' | translate }}</span>
        </div>
        }
      </div>
      } @if (isTerminata() && notExistsNuovaEdizione() ){
      <div class="admin-actions admin-actions-small">
        <div class="admin-action-item small" (click)="riapri()">
          <mat-icon class="calcola-icon">lock_open</mat-icon>
          <span class="action-label">{{ 'LEAGUE.REOPEN' | translate }}</span>
        </div>
        @if (contaAttivi()==0) {
        <div class="admin-action-item small" (click)="secondaOccasione()">
          <mat-icon class="calcola-icon">replay</mat-icon>
          <span class="action-label">{{ 'LEAGUE.SECOND_CHANCE' | translate }}</span>
        </div>
        }
      </div>
      }


      } @if (lega.giocatori?.length) {
      <div class="table-horizontal-wrapper desktop-only">
        <div #tableWrapper class="table-wrapper table-scroll-vertical">
          <table mat-table [dataSource]="lega.giocatori || []" class="giocatori-table">
            <ng-container matColumnDef="nome">
              <th mat-header-cell *matHeaderCellDef class="headerRow"></th>
              <!--D Nome del giocatore-->
              <td mat-cell *matCellDef="let giocatore">
                <div class="nome-giocatore-wrapper">
                  <span class="nome-giocatore">
                    {{ giocatore.nome }}
                  </span>
                  @if(isDaAvviare() && (isAdmin() || this.isLeaderLega())){
                  <mat-icon class="delete-icon" (click)="cancellaGiocatore(giocatore)"
                    matTooltip="Rimuovi il giocatore">delete</mat-icon>
                  }
                </div>
              </td>
            </ng-container>
            @for (giornata of giornataIndices; track giornata) {
            <ng-container [matColumnDef]="'giocata' + (giornata - 1)">
              <!--D Titolo della giornata-->
              <th class="headerRow" mat-header-cell *matHeaderCellDef [class.corrente-col]="
                      giornata + lega.giornataIniziale - 1 ===
                      lega.giornataCorrente
                    ">
                <div>
                  {{
                  getDesGiornataTitle(
                  giornata + lega.giornataIniziale - 1
                  )
                  }}
                </div>
                <div class="stato-giornata">
                  {{ lega.statiGiornate?.[giornata + lega.giornataIniziale - 1]?.descrizione }}
                </div>
              </th>
              <!--D Giocata del giocatore/giornata -->
              <td mat-cell *matCellDef="let giocatore" [class.corrente-col]="
                  giornata + lega.giornataIniziale - 1 ===
                    lega.giornataCorrente && giocatore.statiPerLega?.[lega.id]?.value !== StatoGiocatore.ELIMINATO.value
                " [class.ko-font]="
                      getGiocataByGiornata(giocatore, giornata)?.esito === 'KO'
                    ">
                <span>
                  <ng-container *ngIf="
                          getGiocataByGiornata(giocatore, giornata) as giocata
                        ">
                    <div *ngIf="giocata.squadraSigla || giocata.esito" class="team-logo-container" [ngClass]="{
                            ok: giocata.esito === 'OK',
                            ko: giocata.esito === 'KO',
                            empty: !giocata.esito
                          }" [title]="getSquadraNome(giocata.squadraSigla)">
                      @if(getTeamLogo(giocata.squadraSigla)) {
                        <img
                          class="team-logo-small"
                          [src]="getTeamLogo(giocata.squadraSigla)"
                          [alt]="getSquadraNome(giocata.squadraSigla) || ''"
                          (error)="onLogoError($event)"
                        />
                      } @else {
                        <span class="team-name-fallback">{{ getSquadraNome(giocata.squadraSigla) }}</span>
                      }
                    </div>
                  </ng-container>
                  @if (!visualizzaGiocata(giornata, giocatore)) {
                      <div>
                        <mat-icon
                          class="gioca-icon"
                          [matTooltip]="'LEAGUE.PLAY_NOW' | translate"
                          (click)="giocaGiornata(giocatore, giornata)"
                          >{{ getGiocaIcon() }}</mat-icon
                        >
                      </div>
                  } @else {
                    <!--
                    {{visualizzaGiocata(giornata, giocatore)}}
                    -->
                  }
                </span>
              </td>
            </ng-container>
            }
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"
              [class.eliminato-row]="row.statiPerLega?.[lega.id]?.value === StatoGiocatore.ELIMINATO.value"></tr>
          </table>
        </div>
      </div>

      <!-- Mobile stacked view: shown only on small screens via CSS -->
      <div class="stacked-view mobile-only">
        <div *ngFor="let giocatore of lega.giocatori" class="player-card"
          [class.eliminato-row]="giocatore.statiPerLega?.[lega.id]?.value === StatoGiocatore.ELIMINATO.value">
          <div class="player-header">
            <span class="nome-giocatore">{{ giocatore.nome }}</span>
            <button
              *ngIf="lega.giornataCorrente !== undefined && !visualizzaGiocata(lega.giornataCorrente - lega.giornataIniziale + 1, giocatore)"
              mat-raised-button class="gioca-btn-mobile" (click)="giocaGiornata(giocatore, lega.giornataCorrente-lega.giornataIniziale+1)">
              <mat-icon>{{ getGiocaIcon() }}</mat-icon>
              <span class="btn-text">{{ 'PLAY.PLAY_BUTTON' | translate }}</span>
            </button>
          </div>
          <div class="giornate-list">
            <div *ngFor="let giornata of mobileGiornateIndices()" class="giornata-item">
              <!-- Title -->
              <div class="giornata-number">{{ getDesGiornataTitle(giornata + lega.giornataIniziale - 1) }}</div>

              <!-- Full-width animated status badge -->
              <div class="status-badge-full" [ngClass]="{
                    'in-corso': getStatoGiornataValue(giornata + lega.giornataIniziale - 1) === 'IN_CORSO',
                    'da-giocare': getStatoGiornataValue(giornata + lega.giornataIniziale - 1) === 'DA_GIOCARE',
                    'terminata': getStatoGiornataValue(giornata + lega.giornataIniziale - 1) === 'TERMINATA',
                    'sospesa': getStatoGiornataValue(giornata + lega.giornataIniziale - 1) === 'SOSPESA'
                  }">
                <ng-container *ngIf="getStatoGiornataValue(giornata + lega.giornataIniziale - 1) === 'IN_CORSO'">
                  <span class="status-emoji">‚è≥</span>
                  <span class="status-label">{{ 'LEAGUE.ROUND_IN_PROGRESS' | translate }}</span>
                </ng-container>
                <ng-container *ngIf="getStatoGiornataValue(giornata + lega.giornataIniziale - 1) === 'DA_GIOCARE'">
                  <span class="status-emoji">üéØ</span>
                  <span class="status-label">{{ 'LEAGUE.TO_PLAY' | translate }}</span>
                </ng-container>
                <ng-container *ngIf="getStatoGiornataValue(giornata + lega.giornataIniziale - 1) === 'TERMINATA'">
                  <span class="status-emoji">‚úÖ</span>
                  <span class="status-label">{{ 'LEAGUE.ROUND_COMPLETED' | translate }}</span>
                </ng-container>
                <ng-container *ngIf="getStatoGiornataValue(giornata + lega.giornataIniziale - 1) === 'SOSPESA'">
                  <span class="status-emoji">‚è∏Ô∏è</span>
                  <span class="status-label">{{ 'LEAGUE.SUSPENDED' | translate }}</span>
                </ng-container>
              </div>

              <!-- Team pill - only show if there's a team -->
              <div *ngIf="getSquadraNome(getGiocataByGiornata(giocatore, giornata)?.squadraSigla)"
                class="team-pill-clean" [ngClass]="{
                         'ok': getGiocataByGiornata(giocatore, giornata)?.esito === 'OK',
                         'ko': getGiocataByGiornata(giocatore, giornata)?.esito === 'KO'
                       }">
                @if(getTeamLogo(getGiocataByGiornata(giocatore, giornata)?.squadraSigla)) {
                  <img
                    class="team-logo-mobile"
                    [src]="getTeamLogo(getGiocataByGiornata(giocatore, giornata)?.squadraSigla)"
                    [alt]="getSquadraNome(getGiocataByGiornata(giocatore, giornata)?.squadraSigla) || ''"
                    (error)="onLogoError($event)"
                  />
                } @else {
                  <span class="team-name-mobile-fallback">{{ getSquadraNome(getGiocataByGiornata(giocatore, giornata)?.squadraSigla) }}</span>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
      }

      <!-- SEZIONE ELIMINATO - Mostra quando l'utente corrente √® stato eliminato -->
      <!-- Posizionato dopo la tabella cos√¨ appare sotto alla giocata dell'utente -->
      @if (isCurrentUserEliminato()) {
      <div class="eliminato-banner">
        <div class="eliminato-emoji">üíÄ</div>
        <div class="eliminato-content">
          <div class="eliminato-title">{{ 'LEAGUE.YOU_ELIMINATED' | translate }}</div>
          @if (getSquadraEliminazione()) {
          <div class="eliminato-squadra">
            <span class="eliminato-label">{{ 'LEAGUE.YOU_BETRAYED' | translate }}</span>
            <span class="eliminato-team">{{ getSquadraEliminazione()?.nome }}</span>
            <span class="eliminato-giornata">{{ getDesGiornataTitle(getSquadraEliminazione()?.giornata || 0) }}</span>
          </div>
          }
          <div class="eliminato-message">
            {{ getRandomConsolationMessage() }}
          </div>
        </div>
      </div>
      }

      <!-- ELIMINA LEGA - In fondo, discreto -->
      @if (isDaAvviare() && isLeaderLega()) {
      <div class="delete-lega-footer">
        <span class="delete-link" (click)="toggleDeleteConfirm()">
          <mat-icon>delete_outline</mat-icon>
          {{ 'LEAGUE.DELETE_LEAGUE' | translate }}
        </span>
      </div>
      }

      <!-- DIALOG CONFERMA ELIMINAZIONE -->
      @if (showDeleteConfirm) {
      <div class="delete-confirm-overlay" (click)="toggleDeleteConfirm()">
        <div class="delete-confirm-card" (click)="$event.stopPropagation()">
          <div class="delete-confirm-header">
            <mat-icon class="warning-icon">warning</mat-icon>
            <h3>{{ 'LEAGUE.CONFIRM_DELETE_TITLE' | translate }}</h3>
          </div>
          <p class="delete-confirm-message">
            {{ 'LEAGUE.CONFIRM_DELETE_MESSAGE' | translate }}
          </p>
          <div class="delete-confirm-actions">
            <button class="btn-cancel" (click)="toggleDeleteConfirm()">{{ 'LEAGUE.CONFIRM_DELETE_CANCEL' | translate }}</button>
            <button class="btn-delete" (click)="confirmEliminaLega()" [disabled]="isDeleting">
              {{ isDeleting ? ('LEAGUE.CONFIRM_DELETE_DELETING' | translate) : ('LEAGUE.CONFIRM_DELETE_CONFIRM' | translate) }}
            </button>
          </div>
        </div>
      </div>
      }

    </mat-card-content>
    </mat-card>
    }
</div>
</main>
</div>
