<div class="lega-dettaglio-container">
  <app-header [title]="'LEAGUE.LEAGUE_DETAILS' | translate" (back)="goBack()" (logout)="logout()"></app-header>

  <main class="main-content">
    <div class="lega-dettaglio-container">
      @if (error) {
      <mat-card class="error-card">
        <mat-card-content>{{ error }}</mat-card-content>
      </mat-card>
      } @if (lega) {
      <mat-card class="lega-card">
        <mat-card-header>
          <mat-card-title>{{ lega.name }} - {{ 'LEAGUE.EDITION' | translate }} {{ lega.edizione }}</mat-card-title>
          <mat-card-subtitle>
            <mat-card-subtitle>{{ lega.campionato?.sport?.id }} -
              {{ lega.campionato?.nome }} - {{lega.anno}}</mat-card-subtitle>
            @if (lega.giornataCalcolata){
            <div>{{ 'LEAGUE.CALCULATED_ROUND' | translate }}: {{ getDesGiornataTitle(lega.giornataCalcolata) }}</div>
            }
            @if (lega.giornataDaGiocare <= lega.campionato?.numGiornate!!){ <div>{{ 'LEAGUE.NEXT_CHAMPIONSHIP_ROUND' | translate }}: {{
              getDesGiornataTitle(lega.giornataDaGiocare) }}
            </div>
          }
    <div>{{ 'LEAGUE.YOUR_ROLE' | translate }}: {{ lega.ruoloGiocatoreLega ? lega.ruoloGiocatoreLega.descrizione : ''}}</div>
    <div>{{ 'LEAGUE.LEAGUE_STATE' | translate }}: {{ lega.stato.descrizione }}</div>
    @if (lega.giornataFinale) {
      <div>{{ 'LEAGUE.FINAL_ROUND' | translate }}: {{lega.giornataFinale}}</div>
    }
          </mat-card-subtitle>
        </mat-card-header>

        @if (!this.isTerminata()){
        <!-- COUNTDOWN TIMER - Centrato con spazio sopra -->
        <div class="countdown-timer-section">
          @if(countdownActive) {
          <div class="countdown-wrapper" [class.expired]="countdownExpired">
            <mat-icon class="countdown-icon">schedule</mat-icon>
            <div class="countdown-content">
              @if(!countdownExpired) {
                <span class="countdown-label">{{ 'LEAGUE.CLOSING_IN' | translate }}</span>
              }
              <span class="countdown-time">{{ countdown }}</span>
            </div>
          </div>
          } @else if(lega.inizioProssimaGiornata) {
          <div class="prossimo-inizio">{{ 'LEAGUE.NEXT_START' | translate }}: {{ lega.inizioProssimaGiornata }}</div>
          }
        </div>
      }
    <mat-card-content>
      @if (isAdmin() || this.isLeaderLega()) { @if (isAvviata()){
      <div class="admin-actions">
        <div class="admin-action-item" (click)="calcolaGiornata()">
          <mat-icon class="calcola-icon">calculate</mat-icon>
          <span class="action-label">{{ 'LEAGUE.CALCULATE' | translate }}</span>
        </div>
        <div class="admin-action-item" (click)="undoCalcolaGiornata()">
          <mat-icon class="calcola-icon">undo</mat-icon>
          <span class="action-label">{{ 'COMMON.CANCEL' | translate }}</span>
        </div>
        <div class="admin-action-item" (click)="sospensioni()">
          <mat-icon class="calcola-icon">pause_circle</mat-icon>
          <span class="action-label">{{ 'LEAGUE.SUSPENSIONS' | translate }}</span>
        </div>
        @if (isChiudibile()){
        <div class="admin-action-item" (click)="termina()">
          <mat-icon class="calcola-icon">lock</mat-icon>
          <span class="action-label">{{ 'COMMON.CLOSE' | translate }}</span>
        </div>
        }
      </div>
      } @if (isTerminata() && notExistsNuovaEdizione() ){
      <div class="admin-actions admin-actions-small">
        <div class="admin-action-item small" (click)="riapri()">
          <mat-icon class="calcola-icon">lock_open</mat-icon>
          <span class="action-label">{{ 'LEAGUE.REOPEN' | translate }}</span>
        </div>
        @if (contaAttivi()==0) {
        <div class="admin-action-item small" (click)="secondaOccasione()">
          <mat-icon class="calcola-icon">replay</mat-icon>
          <span class="action-label">{{ 'LEAGUE.SECOND_CHANCE' | translate }}</span>
        </div>
        }
      </div>
      }


      } @if (lega.giocatori?.length) {

      <!-- BOTTONE GIOCA PRINCIPALE - IN PRIMO PIANO -->
      @if (getCurrentGiocatore() && hasGiocataDisponibile(getCurrentGiocatore())) {
        <div class="play-action-primary">
          <button class="btn-play-primary" (click)="giocaGiornataDisponibile(getCurrentGiocatore())">
            <mat-icon class="play-icon-primary">{{ getGiocaIcon() }}</mat-icon>
            <span class="play-label-primary">{{ 'LEAGUE.PLAY_NOW' | translate }}</span>
          </button>
        </div>
      }

      <!-- RICERCA E FILTRI PER DESKTOP/TABLET -->
      <div class="desktop-filters-section desktop-tablet-only">
        <!-- Ricerca utente -->
        <div class="search-bar-desktop">
          <mat-icon class="search-icon-desktop">search</mat-icon>
          <input
            type="text"
            class="search-input-desktop"
            [(ngModel)]="searchText"
            (ngModelChange)="onSearchChange()"
            placeholder="Cerca giocatore..."
          />
          <button *ngIf="searchText" class="clear-search-btn-desktop" (click)="clearSearch()">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <!-- Filtri chips -->
        <div class="filter-chips-desktop">
          <button
            class="filter-chip-desktop"
            [class.active]="playerFilter === 'all'"
            (click)="setPlayerFilter('all')"
          >
            <span class="chip-label-desktop">Tutti</span>
            <span class="chip-count-desktop">{{ getTotalPlayersCount() }}</span>
          </button>
          <button
            class="filter-chip-desktop active-chip"
            [class.active]="playerFilter === 'active'"
            (click)="setPlayerFilter('active')"
          >
            <span class="chip-label-desktop">Attivi</span>
            <span class="chip-count-desktop">{{ getActivePlayersCount() }}</span>
          </button>
          <button
            class="filter-chip-desktop eliminated-chip"
            [class.active]="playerFilter === 'eliminated'"
            (click)="setPlayerFilter('eliminated')"
          >
            <span class="chip-label-desktop">Eliminati</span>
            <span class="chip-count-desktop">{{ getEliminatedPlayersCount() }}</span>
          </button>
        </div>
      </div>

      <!-- VISTA DESKTOP/TABLET - Tabella Compatta Tipo Excel -->
      <div class="excel-table-wrapper desktop-tablet-only">
        <div class="excel-table-scroll">
          <table class="excel-table">
            <!-- HEADER FISSO -->
            <thead>
              <tr class="excel-header-row">
                <th class="excel-header-cell user-col">Utente</th>
                <th class="excel-header-cell status-col">Stato</th>
                @for (giornata of giornataIndices; track giornata) {
                  <th class="excel-header-cell round-col"
                      [class.current-round]="giornata === lega.giornataCorrente">
                    {{ getDesGiornataTitle(giornata) }}
                  </th>
                }
              </tr>
            </thead>

            <!-- BODY -->
            <tbody>
              @for (giocatore of getFilteredPlayers(); track giocatore.id) {
                <tr class="excel-data-row"
                    [class.eliminated]="giocatore.statiPerLega?.[lega.id]?.value === StatoGiocatore.ELIMINATO.value">

                  <!-- NOME UTENTE -->
                  <td class="excel-cell user-cell">
                    <span class="user-name">{{ giocatore.nome }}</span>
                    @if(isDaAvviare() && (isAdmin() || isLeaderLega())){
                      <mat-icon class="delete-user-icon" (click)="cancellaGiocatore(giocatore)"
                                matTooltip="Rimuovi giocatore">close</mat-icon>
                    }
                  </td>

                  <!-- STATO -->
                  <td class="excel-cell status-cell">
                    <span class="status-badge"
                          [class.active]="giocatore.statiPerLega?.[lega.id]?.value !== StatoGiocatore.ELIMINATO.value"
                          [class.eliminated]="giocatore.statiPerLega?.[lega.id]?.value === StatoGiocatore.ELIMINATO.value">
                      {{ giocatore.statiPerLega?.[lega.id]?.value === StatoGiocatore.ELIMINATO.value ? '‚ùå' : '‚úÖ' }}
                    </span>
                  </td>

                  <!-- GIORNATE -->
                  @for (giornata of giornataIndices; track giornata) {
                    <td class="excel-cell round-cell"
                        [class.current-round]="giornata === lega.giornataCorrente"
                        [class.cell-ok]="getGiocataByGiornataAssoluta(giocatore, giornata)?.esito === 'OK'"
                        [class.cell-ko]="getGiocataByGiornataAssoluta(giocatore, giornata)?.esito === 'KO'">

                      @if(getGiocataByGiornataAssoluta(giocatore, giornata)?.squadraSigla) {
                        <!-- Mostra il nome COMPLETO della squadra o badge "Voto Privato" se nascosta -->
                        <span
                          [class]="shouldHideGiocata(getGiocataByGiornataAssoluta(giocatore, giornata), giornata) ? 'private-vote-badge' : 'team-name-compact'"
                          [title]="shouldHideGiocata(getGiocataByGiornataAssoluta(giocatore, giornata), giornata) ? 'Voto nascosto fino all\'inizio della giornata' : getSquadraNome(getGiocataByGiornataAssoluta(giocatore, giornata)?.squadraSigla)">
                          {{ getDisplaySquadraNome(giocatore, giornata) }}
                        </span>
                      } @else {
                        <!-- Mostra bottone Gioca se √® l'utente loggato e non ha giocato -->
                        @if (isCurrentUserGiocatore(giocatore) && !getGiocataByGiornataAssoluta(giocatore, giornata)) {
                          <button class="play-btn-tiny"
                                  (click)="giocaGiornataAssoluta(giocatore, giornata)"
                                  matTooltip="Gioca Ora">
                            <mat-icon>sports_soccer</mat-icon>
                          </button>
                        } @else {
                          <!-- Cella vuota per gli altri giocatori -->
                          <span class="empty-cell">-</span>
                        }
                      }
                    </td>
                  }
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

      <!-- Vista Cards Moderna - Responsive per tutti i dispositivi -->
      <div class="cards-view-responsive">

        <!-- FILTRI E RICERCA MODERNI -->
        <div class="mobile-filters-section">
          <!-- Ricerca veloce -->
          <div class="search-bar-container">
            <mat-icon class="search-icon">search</mat-icon>
            <input
              type="text"
              class="search-input"
              [(ngModel)]="searchText"
              (ngModelChange)="onSearchChange()"
              placeholder="{{ 'LEAGUE.SEARCH_PLAYER' | translate }}"
            />
            <button *ngIf="searchText" class="clear-search-btn" (click)="clearSearch()">
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <!-- Filtri chips -->
          <div class="filter-chips">
            <button
              class="filter-chip"
              [class.active]="playerFilter === 'all'"
              (click)="setPlayerFilter('all')"
            >
              <span class="chip-label">{{ 'LEAGUE.ALL' | translate }}</span>
              <span class="chip-count">{{ getTotalPlayersCount() }}</span>
            </button>
            <button
              class="filter-chip active-chip"
              [class.active]="playerFilter === 'active'"
              (click)="setPlayerFilter('active')"
            >
              <span class="chip-label">{{ 'LEAGUE.ACTIVE' | translate }}</span>
              <span class="chip-count">{{ getActivePlayersCount() }}</span>
            </button>
            <button
              class="filter-chip eliminated-chip"
              [class.active]="playerFilter === 'eliminated'"
              (click)="setPlayerFilter('eliminated')"
            >
              <span class="chip-label">{{ 'LEAGUE.ELIMINATED' | translate }}</span>
              <span class="chip-count">{{ getEliminatedPlayersCount() }}</span>
            </button>
          </div>
        </div>

        <!-- EMPTY STATE - Nessun risultato -->
        @if (getFilteredPlayers().length === 0) {
          <div class="empty-state">
            <mat-icon class="empty-icon">search_off</mat-icon>
            <div class="empty-title">{{ 'LEAGUE.NO_RESULTS' | translate }}</div>
            <div class="empty-message">
              {{ searchText ? ('LEAGUE.NO_RESULTS_SEARCH' | translate) : ('LEAGUE.NO_RESULTS_FILTER' | translate) }}
            </div>
          </div>
        }

        <!-- LISTA GIOCATORI FILTRATI -->
        <div *ngFor="let giocatore of getFilteredPlayers(); trackBy: trackByGiocatoreId" class="player-card-mobile"
          [class.eliminato-row]="giocatore.statiPerLega?.[lega.id]?.value === StatoGiocatore.ELIMINATO.value"
          [class.expanded]="expandedPlayers[giocatore.id]">

          <!-- Header giocatore compatto - Nome + Freccia sulla stessa riga -->
          <div class="player-header-mobile" (click)="togglePlayerExpansion(giocatore.id)">
            <!-- Sinistra: Nome + Badge stato -->
            <div class="player-info-left">
              <span class="nome-giocatore-mobile">{{ giocatore.nome }}</span>
              <span class="player-status-badge-mobile"
                    [class.active]="giocatore.statiPerLega?.[lega.id]?.value !== StatoGiocatore.ELIMINATO.value">
                {{ giocatore.statiPerLega?.[lega.id]?.value === StatoGiocatore.ELIMINATO.value ? '‚ùå' : '‚úÖ' }}
              </span>
            </div>

            <!-- Destra: Freccia -->
            <mat-icon class="expand-icon-mobile">
              {{ expandedPlayers[giocatore.id] ? 'keyboard_arrow_up' : 'keyboard_arrow_down' }}
            </mat-icon>
          </div>

          <!-- Storia completa giocate - ESPANDIBILE -->
          <div class="giornate-list-mobile" *ngIf="expandedPlayers[giocatore.id]" [@expandCollapse]>
            <!-- Header settimane -->
            <div class="settimane-header">
              <div *ngFor="let giornata of mobileGiornateIndices()" class="settimana-col">
                <span class="settimana-label">{{ getDesGiornataTitle(giornata) }}</span>
              </div>
            </div>

            <!-- Giocate -->
            <div class="giocate-row">
              <div *ngFor="let giornata of mobileGiornateIndices()" class="giocata-col">
                <!-- Team scelto -->
                @if(getGiocataByGiornataAssoluta(giocatore, giornata)?.squadraSigla) {
                  <div class="team-cell-mobile"
                       [class.cell-ok]="getGiocataByGiornataAssoluta(giocatore, giornata)?.esito === 'OK'"
                       [class.cell-ko]="getGiocataByGiornataAssoluta(giocatore, giornata)?.esito === 'KO'">
                    @if(getTeamLogo(getGiocataByGiornataAssoluta(giocatore, giornata)?.squadraSigla)) {
                      <img
                        class="team-logo-cell"
                        [src]="getTeamLogo(getGiocataByGiornataAssoluta(giocatore, giornata)?.squadraSigla)"
                        [alt]="getSquadraNome(getGiocataByGiornataAssoluta(giocatore, giornata)?.squadraSigla) || ''"
                        (error)="onLogoError($event)"
                      />
                    }
                    <span class="team-name-cell">{{ getSquadraNome(getGiocataByGiornataAssoluta(giocatore, giornata)?.squadraSigla) }}</span>
                  </div>
                } @else {
                  <!-- Cella vuota -->
                  <div class="empty-cell-mobile">-</div>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
      }


      <!-- SEZIONE ELIMINATO - Mostra quando l'utente corrente √® stato eliminato -->
      <!-- Posizionato dopo la tabella cos√¨ appare sotto alla giocata dell'utente -->
      @if (isCurrentUserEliminato()) {
      <div class="eliminato-banner">
        <div class="eliminato-emoji">üíÄ</div>
        <div class="eliminato-content">
          <div class="eliminato-title">{{ 'LEAGUE.YOU_ELIMINATED' | translate }}</div>
          @if (getSquadraEliminazione()) {
          <div class="eliminato-squadra">
            <span class="eliminato-label">{{ 'LEAGUE.YOU_BETRAYED' | translate }}</span>
            <span class="eliminato-team">{{ getSquadraEliminazione()?.nome }}</span>
            <span class="eliminato-giornata">{{ getDesGiornataTitle(getSquadraEliminazione()?.giornata || 0) }}</span>
          </div>
          }
          <div class="eliminato-message">
            {{ getRandomConsolationMessage() }}
          </div>
        </div>
      </div>
      }

      <!-- ELIMINA LEGA - In fondo, discreto -->
      @if (isDaAvviare() && isLeaderLega()) {
      <div class="delete-lega-footer">
        <span class="delete-link" (click)="toggleDeleteConfirm()">
          <mat-icon>delete_outline</mat-icon>
          {{ 'LEAGUE.DELETE_LEAGUE' | translate }}
        </span>
      </div>
      }

      <!-- DIALOG CONFERMA ELIMINAZIONE -->
      @if (showDeleteConfirm) {
      <div class="delete-confirm-overlay" (click)="toggleDeleteConfirm()">
        <div class="delete-confirm-card" (click)="$event.stopPropagation()">
          <div class="delete-confirm-header">
            <mat-icon class="warning-icon">warning</mat-icon>
            <h3>{{ 'LEAGUE.CONFIRM_DELETE_TITLE' | translate }}</h3>
          </div>
          <p class="delete-confirm-message">
            {{ 'LEAGUE.CONFIRM_DELETE_MESSAGE' | translate }}
          </p>
          <div class="delete-confirm-actions">
            <button class="btn-cancel" (click)="toggleDeleteConfirm()">{{ 'LEAGUE.CONFIRM_DELETE_CANCEL' | translate }}</button>
            <button class="btn-delete" (click)="confirmEliminaLega()" [disabled]="isDeleting">
              {{ isDeleting ? ('LEAGUE.CONFIRM_DELETE_DELETING' | translate) : ('LEAGUE.CONFIRM_DELETE_CONFIRM' | translate) }}
            </button>
          </div>
        </div>
      </div>
      }

    </mat-card-content>
    </mat-card>
    }
</div>
</main>
</div>
