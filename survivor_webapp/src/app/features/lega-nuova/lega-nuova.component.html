<app-header
  [title]="'CREATE_LEAGUE.TITLE' | translate"
  (back)="goBack()"
  (logout)="logout()"
></app-header>

<main class="main-content">
  <div class="main-panel">
    <mat-card class="message-box" [class.single-card]="confirmationMessage">
      <mat-card-content>
        <form
          *ngIf="!confirmationMessage"
          class="form-vertical"
          (ngSubmit)="onSubmit()"
        >
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'CREATE_LEAGUE.LEAGUE_NAME' | translate }}</mat-label>
              <input
                matInput
                name="name"
                [placeholder]="'CREATE_LEAGUE.LEAGUE_NAME_PLACEHOLDER' | translate"
                [(ngModel)]="name"
                (blur)="nameTouched = true"
              />
              <mat-error *ngIf="nameTouched && !name"
                >{{ 'CREATE_LEAGUE.LEAGUE_NAME' | translate }} {{ 'COMMON.REQUIRED' | translate }}</mat-error
              >
            </mat-form-field>
          </div>
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'CREATE_LEAGUE.SPORT' | translate }}</mat-label>
              <mat-select
                name="sportSel"
                [(ngModel)]="sportSel"
                (selectionChange)="sportTouched = true; selezionaSport()"
              >
                @for (sport of sportDisponibili; track sport.id) {
                <mat-option [value]="sport.id">{{ sport.nome }}</mat-option>
                }
              </mat-select>
              <mat-error *ngIf="sportTouched && !sportSel"
                >{{ 'CREATE_LEAGUE.SPORT' | translate }} {{ 'COMMON.REQUIRED' | translate }}</mat-error
              >
            </mat-form-field>
          </div>
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'CREATE_LEAGUE.CHAMPIONSHIP' | translate }}</mat-label>
              <mat-select
                name="campionatoSel"
                [(ngModel)]="campionatoSel"
                (selectionChange)="campionatoTouched = true"
              >
                @for (campionato of campionatiDisponibili; track campionato.id)
                {
                <mat-option [value]="campionato">{{
                  campionato.nome
                }}</mat-option>
                }
              </mat-select>
              <mat-error *ngIf="campionatoTouched && !campionatoSel"
                >{{ 'CREATE_LEAGUE.CHAMPIONSHIP' | translate }} {{ 'COMMON.REQUIRED' | translate }}</mat-error
              >
            </mat-form-field>
          </div>

          @if((campionatoSel?.giornataDaGiocare || 0) <=
          (campionatoSel?.numGiornate|| 0)){
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label
                >{{ 'CREATE_LEAGUE.INITIAL_ROUND' | translate }} {{ campionatoSel?.giornataDaGiocare }}-{{
                  campionatoSel?.numGiornate
                }}</mat-label
              >
              <input
                matInput
                name="giornataIniziale"
                [(ngModel)]="giornataIniziale"
                type="number"
                (blur)="giornataTouched = true"
                [attr.min]="campionatoSel?.giornataDaGiocare"
                [attr.max]="campionatoSel?.numGiornate"
              />
              <mat-error
                *ngIf="
                  giornataTouched &&
                  (giornataIniziale === null || giornataIniziale === undefined)
                "
                >{{ 'CREATE_LEAGUE.INITIAL_ROUND' | translate }} {{ 'COMMON.REQUIRED' | translate }}</mat-error
              >
              <mat-error *ngIf="giornataTouched && !isGiornataValid()"
                >{{ 'CREATE_LEAGUE.INITIAL_ROUND_ERROR' | translate }}
                {{ campionatoSel?.giornataDaGiocare }} {{ 'COMMON.AND' | translate }}
                {{ campionatoSel?.numGiornate }}</mat-error
              >
            </mat-form-field>
          </div>
          } @if(campionatoSel && (campionatoSel.giornataDaGiocare || 0) > (campionatoSel.numGiornate|| 0)){
          <mat-label>{{ 'CREATE_LEAGUE.CHAMPIONSHIP_ENDED' | translate }}</mat-label>
          }

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'CREATE_LEAGUE.PASSWORD' | translate }}</mat-label>
              <input
                matInput
                name="pwd"
                [placeholder]="'CREATE_LEAGUE.PASSWORD_PLACEHOLDER' | translate"
                [(ngModel)]="pwd"
                type="text"
              />
            </mat-form-field>
          </div>

          <div class="form-row actions">
            <button
              mat-raised-button
              color="primary"
              [disabled]="!isFormValid()"
            >
              {{ 'CREATE_LEAGUE.CREATE_BUTTON' | translate }}
            </button>
          </div>
        </form>

        <div class="confirmation" *ngIf="confirmationMessage">
          <mat-card class="confirmation-card">
            <mat-card-content>
              <p class="success-message" [innerHTML]="'CREATE_LEAGUE.SUCCESS_MESSAGE' | translate: {name: name}">
              </p>
              <p>{{ 'CREATE_LEAGUE.SHARE_URL' | translate }}</p>

              <div class="link-row">
                <a class="share-link" [href]="baseUrl() + '/joinLega'">{{ baseUrl() }}/joinLega</a>

                <button
                  mat-icon-button
                  color="primary"
                  (click)="copyLink()"
                  [attr.aria-label]="'COMMON.COPY_LINK' | translate"
                >
                  <mat-icon>{{ copied ? 'check' : 'content_copy' }}</mat-icon>
                </button>

                <span class="copy-feedback" *ngIf="copied">{{ 'COMMON.COPIED' | translate }}</span>
              </div>

              <span *ngIf="pwd">{{ 'CREATE_LEAGUE.WITH_PASSWORD_JOIN' | translate }} <b>{{ pwd }}</b></span>

              <div class="invite-section">
                <h3>{{ 'CREATE_LEAGUE.INVITE_EMAIL' | translate }}</h3>

                <div class="email-input-section">
                  <mat-form-field appearance="outline" class="email-field" subscriptSizing="dynamic">
                    <input
                      matInput
                      [placeholder]="'CREATE_LEAGUE.EMAIL_PLACEHOLDER' | translate"
                      [(ngModel)]="emailInput"
                      (keyup.enter)="addEmail()"
                    />
                  </mat-form-field>
                  <button
                    mat-raised-button
                    color="accent"
                    (click)="addEmail()"
                    [disabled]="!isValidEmail(emailInput)"
                  >
                    {{ 'COMMON.ADD' | translate }}
                  </button>
                </div>

                <div class="emails-list" *ngIf="emailsList.length > 0">
                  <mat-chip-set>
                    <mat-chip
                      *ngFor="let email of emailsList"
                      (removed)="removeEmail(email)"
                    >
                      {{ email }}
                      <button matChipRemove>
                        <mat-icon>cancel</mat-icon>
                      </button>
                    </mat-chip>
                  </mat-chip-set>
                </div>

                <div class="invite-actions" *ngIf="emailsList.length > 0">
                  <button
                    mat-raised-button
                    color="primary"
                    (click)="invitaUtenti()"
                  >
                    {{ 'COMMON.SEND_INVITES' | translate }} ({{ emailsList.length }})
                  </button>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</main>
